#!/usr/bin/env bash
set -euo pipefail
# Enhanced Nix update with progress tracking

echo "â„ï¸  Nix Update & Rebuild"
echo "======================="
echo ""

# Navigate to dotfiles
pushd ~/.dotfiles > /dev/null

# Show current state
echo "ðŸ“ Current state:"
if [[ -f flake.lock ]]; then
    last_update=$(date -r flake.lock "+%Y-%m-%d %H:%M" 2>/dev/null || echo "unknown")
    echo "   Last update: $last_update"
fi
echo ""

# Update flake inputs
echo "ðŸ”„ [1/3] Updating flake inputs..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if nix flake update 2>&1 | while IFS= read -r line; do
    if [[ "$line" =~ Updated.*input ]]; then
        input=$(echo "$line" | sed -E "s/.*'([^']+)'.*/\1/")
        echo "   âœ“ Updated: $input"
    elif [[ "$line" =~ warning ]]; then
        echo "   âš  $line"
    fi
done; then
    echo ""
    echo "âœ… Flake inputs updated"
else
    echo "âŒ Failed to update flake inputs"
    popd > /dev/null
    exit 1
fi
echo ""

# Show what changed
echo "ðŸ“ Changes in flake.lock:"
git diff --no-index --color=always --word-diff=color /dev/null flake.lock 2>/dev/null | head -20 || echo "   (no changes)"
echo ""

# Build and switch
echo "ðŸ”¨ [2/3] Building new configuration..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
~/Scripts/nixswitch

if [[ $? -eq 0 ]]; then
    echo ""
    echo "ðŸŽ‰ [3/3] Update complete!"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    # Show new state
    if [[ "$OSTYPE" == "darwin"* ]]; then
        new_gen=$(darwin-rebuild --list-generations 2>/dev/null | tail -1)
    else
        new_gen=$(nixos-rebuild list-generations 2>/dev/null | tail -1)
    fi

    echo "   New generation: $new_gen"
    echo ""
    echo "âœ¨ Your system is now up to date!"
else
    echo ""
    echo "âŒ Build failed. Check errors above."
    popd > /dev/null
    exit 1
fi

popd > /dev/null
